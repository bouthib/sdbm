CONNECT / AS SYSDBA
alter session set container = XEPDB1;

--
-- Cleanup (remove data from import)
--

-- Force new key to be generated
DELETE FROM SDBM.DEFAUT WHERE CLE = 'KEY_BYTES_HEX';

-- Update wallet-smtp location
UPDATE SDBM.PARAMETRE
   SET CHEMIN_WALLET_SMTP = 'file:' || SUBSTR(SYS_CONTEXT('USERENV','ORACLE_HOME'),1,INSTR(SYS_CONTEXT('USERENV','ORACLE_HOME'),'\oraclexe\')) || 'oraclexe\admin\XE\smtp-wallet';

TRUNCATE TABLE SDBM.CD_ASM_DISKGROUP;
TRUNCATE TABLE SDBM.CD_DBA_DATA_FILES;
TRUNCATE TABLE SDBM.CD_ESPACE_ARCHIVED_LOG;
TRUNCATE TABLE SDBM.CD_FILESTAT;
TRUNCATE TABLE SDBM.CD_INFO_DYNAMIQUE_AGT;
TRUNCATE TABLE SDBM.CD_INFO_DYNAMIQUE_CPU_AGT;
TRUNCATE TABLE SDBM.CD_INFO_STATIQUE_AGT;
TRUNCATE TABLE SDBM.CD_RAPPORT_IO_STAT;
TRUNCATE TABLE SDBM.CD_SYSSTAT_CPU;
TRUNCATE TABLE SDBM.CD_TRANSACTION_LOG;

DELETE FROM SDBM.CIBLE;
DELETE FROM SDBM.HIST_CIBLE;
DELETE FROM SDBM.HIST_EVENEMENT_CIBLE;

DELETE FROM SDBM.INFO_AGT;
DELETE FROM SDBM.TACHE_AGT;

DELETE FROM SDBM.VOLUME_PHY WHERE ID_VOLUME_PHY != 0;

TRUNCATE TABLE SDBM.AUDIT_APPL;
TRUNCATE TABLE SDBM.JOURNAL;

/* Ajustement des s√©quences */
DECLARE

   CURSOR C_SEQUENCE IS
      SELECT SEQUENCE_NAME
            ,LAST_NUMBER
        FROM DBA_SEQUENCES
       WHERE SEQUENCE_OWNER = 'SDBM';

   V_SEQ NUMBER;

BEGIN

   FOR RC_SEQUENCE IN C_SEQUENCE LOOP

      EXECUTE IMMEDIATE 'ALTER SEQUENCE SDBM.' || RC_SEQUENCE.SEQUENCE_NAME || ' INCREMENT BY -' || TO_CHAR(RC_SEQUENCE.LAST_NUMBER) || ' MINVALUE -1';
      EXECUTE IMMEDIATE 'SELECT SDBM.' || RC_SEQUENCE.SEQUENCE_NAME || '.NEXTVAL FROM DUAL'
         INTO V_SEQ;
      EXECUTE IMMEDIATE 'ALTER SEQUENCE SDBM.' || RC_SEQUENCE.SEQUENCE_NAME || ' INCREMENT BY 1';
      EXECUTE IMMEDIATE 'SELECT SDBM.' || RC_SEQUENCE.SEQUENCE_NAME || '.NEXTVAL FROM DUAL'
         INTO V_SEQ;
      EXECUTE IMMEDIATE 'ALTER SEQUENCE SDBM.' || RC_SEQUENCE.SEQUENCE_NAME || ' MINVALUE 0';

   END LOOP;

END;
/


--
-- Monitoring of SDBM database
--
INSERT INTO SDBM.CIBLE
(
   TYPE_CIBLE
  ,SOUS_TYPE_CIBLE
  ,NOM_CIBLE
  ,NOM_USAGER
  ,MDP_USAGER
  ,TYPE_CONNEXION
  ,CONNEXION
  ,DESTI_NOTIF
  ,SQL_HORAIRE
)
VALUES
(
   'BD'
  ,'OR'
  ,'SDBM'
  ,'SDBMON'
  ,'changeme-mon'
  ,'NO'
  ,'(DESCRIPTION =
   (ADDRESS_LIST =
      (ADDRESS = 
         (PROTOCOL = TCP)
         (HOST     = localhost)
         (PORT     = 1521)
      )
   )
   (CONNECT_DATA =
      (SERVICE_NAME = XEPDB1.sdbm.ca)
      (SERVER = DEDICATED)
   )
)
'
  ,'---'
  ,'SELECT 1
  FROM DUAL
 WHERE /* JOUR  */ (TRIM(TO_CHAR(SYSDATE,''DAY'',''NLS_DATE_LANGUAGE = AMERICAN''))
    IN (''MONDAY'',''TUESDAY'',''WEDNESDAY'',''THURSDAY'',''FRIDAY'',''SATURDAY'',''SUNDAY''))
   AND /* HEURE */ (TO_CHAR(SYSDATE,''HH24:MI'') BETWEEN ''00:00'' AND ''23:59'')
'
);

INSERT INTO SDBM.EVENEMENT_CIBLE
(
   TYPE_CIBLE
  ,SOUS_TYPE_CIBLE
  ,NOM_CIBLE
  ,NOM_EVENEMENT
)
SELECT TYPE_CIBLE
      ,SOUS_TYPE_CIBLE
      ,'SDBM'
      ,NOM_EVENEMENT
  FROM SDBM.EVENEMENT
 WHERE TYPE_CIBLE      = 'BD'
   AND SOUS_TYPE_CIBLE = 'OR' 
   AND NOM_EVENEMENT   NOT LIKE 'ASM%'
   AND NOM_EVENEMENT   NOT LIKE 'DEFERROR'
   AND NOM_EVENEMENT   NOT LIKE 'LOGSTDBY.%'
   AND NOM_EVENEMENT   NOT LIKE 'PHYSTDBY.%'
   AND NOM_EVENEMENT   NOT LIKE 'RMAN_%'
   AND NOM_EVENEMENT   NOT LIKE 'SDBM.SDBMSRV'
   AND NOM_EVENEMENT   NOT LIKE 'SPACE_CRITICAL'
   AND NOM_EVENEMENT   NOT LIKE 'STREAM.%'
   AND NOM_EVENEMENT   NOT LIKE 'TEST'
   AND NOM_EVENEMENT   NOT LIKE 'CD_ASM_DISKGROUP';


DECLARE

   V_VOLUME VARCHAR2(3);
   
BEGIN

   SELECT DISTINCT SUBSTR(FILE_NAME,1,3)
     INTO V_VOLUME
     FROM DBA_DATA_FILES;

   INSERT INTO SDBM.VOLUME_PHY
   (
      DESC_VOLUME_PHY
     ,TOTAL_MB
     ,CHEMIN_ACCES_DEFAUT
   )
   VALUES
   (
      'SDBM_' || V_VOLUME
      ,10240
      ,V_VOLUME || 'SDBM'
   );

   INSERT INTO SDBM.VOLUME_PHY_CIBLE
   (
      ID_VOLUME_PHY
     ,TYPE_CIBLE
     ,NOM_CIBLE
     ,CHEMIN_ACCES
   )
   VALUES
   (
      1
     ,'BD'
     ,'SDBM'
     ,V_VOLUME || 'SDBM'
   );

END;
/

COMMIT;


exit
